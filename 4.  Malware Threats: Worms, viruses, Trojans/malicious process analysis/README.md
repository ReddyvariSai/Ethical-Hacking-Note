# **MALICIOUS PROCESS ANALYSIS**

Deep dive into techniques, tools, and methodologies for analyzing malicious processes in memory.

---

## **WHY PROCESS ANALYSIS MATTERS**

Malicious processes are the **living manifestation** of malware execution. While files can be obfuscated, packed, or encrypted, running processes must **reveal their true behavior** to function.

---

## **ANALYSIS APPROACHES**

### **1. STATIC PROCESS ANALYSIS**
Analyzing the **executable on disk** before execution.

#### **Key Techniques:**
- **PE Header Analysis:** Sections, imports, exports, resources
- **String Extraction:** Hardcoded IPs, URLs, file paths, commands
- **Import Address Table (IAT):** What system APIs are called
- **Entropy Analysis:** Detect packing/encryption
- **Digital Signatures:** Valid/revoked/stolen certificates

#### **Tools:**
```
PEStudio, CFF Explorer, Detect It Easy (DIE), Exeinfo PE
strings, floss (FireEye Labs Obfuscated String Solver)
```

---

### **2. DYNAMIC PROCESS ANALYSIS**
Monitoring **behavior during execution**.

#### **Key Monitoring Areas:**

| **System Aspect** | **What to Monitor** | **Why It Matters** |
|-------------------|---------------------|-------------------|
| **Process Tree** | Parent-child relationships | Spot process hollowing, injection |
| **File System** | Files created/modified/deleted | Data exfiltration, persistence |
| **Registry** | Keys created/modified | Persistence, configuration |
| **Network** | Connections, DNS queries | C2 communication, data theft |
| **Memory** | Allocations, injections | Hidden code, unpacked payloads |

#### **Tools:**
```
ProcMon (Process Monitor), Process Hacker, Process Explorer
API Monitor, Fiddler/Wireshark (network), RegShot (registry)
```

---

### **3. MEMORY ANALYSIS**
Forensic examination of **process memory**.

#### **What to Look For in Memory:**

```python
# Common memory artifacts:
artifacts = {
    "unpacked_code": "Original malware after decryption",
    "injected_code": "DLLs/PEs in other processes",
    "encryption_keys": "For C2 communication or file encryption",
    "credentials": "Passwords, tokens, browser data",
    "configuration": "C2 addresses, campaign IDs, timers",
    "network_artifacts": "Sockets, connections, buffers",
    "process_hollowing": "Legitimate process with replaced memory"
}
```

#### **Memory Acquisition Methods:**
- **Full Memory Dump:** `WinPmem`, `FTK Imager`, `DumpIt`
- **Process-Specific Dump:** `Procdump`, `Process Hacker`
- **Live Memory Analysis:** `Volatility`, `Rekall`

---

## **COMMON MALICIOUS PROCESS PATTERNS**

### **1. PROCESS INJECTION TECHNIQUES**

#### **DLL Injection:**
```
Attacker Process → Allocates memory in target → Writes DLL path → Creates remote thread
```
- **Detection:** Unusual DLLs in process, cross-process memory operations
- **Tools:** `ListDLLs`, `Process Hacker DLL view`

#### **Process Hollowing:**
```
Create legitimate process suspended → Replace memory with malicious code → Resume execution
```
- **Detection:** Process image mismatch (disk vs memory), unusual section permissions
- **Volatility Command:** `pslist` vs `psscan` discrepancies

#### **Thread Execution Hijacking:**
```
Suspend legitimate thread → Redirect execution → Resume thread
```
- **Detection:** Thread start address outside module range

#### **APC Injection:**
```
Queue Asynchronous Procedure Call → Execute when thread alertable
```
- **Detection:** Unexpected APCs, user-mode APCs to system threads

### **2. DEFENSE EVASION PATTERNS**

#### **Parent-Process ID (PPID) Spoofing:**
```cpp
// Common targets for spoofing:
// explorer.exe, svchost.exe, services.exe
```
- **Detection:** Unusual parent-child relationships
- **Tool:** `Get-ParentProcess` in PowerShell

#### **Process Doppelgänging:**
- Uses NTFS transactions to load malicious code
- **Detection:** Transactional NTFS operations, section object anomalies

#### **Module Stomping:**
- Overwrites legitimate DLL in memory
- **Detection:** Modified DLLs, unusual write permissions to image memory

---

## **ANALYSIS WORKFLOW**

### **Step 1: Initial Triage**
```bash
# Quick system snapshot
pslist.exe /accepteula > processes.txt
handle.exe /accepteula > handles.txt
netstat -anob > network.txt
autoruns.exe /accepteula > autostart.txt
```

### **Step 2: Suspicious Process Identification**

#### **Indicators of Compromise (IoCs):**
- **High CPU with no user activity**
- **Network connections to suspicious IPs/ports**
- **Unusual process names:**
  - Misspellings: `chr0me.exe`, `scvhost.exe`
  - Legitimate names in wrong locations: `lsass.exe` in `C:\Temp\`
  - Random names: `x8j3s9.exe`, `setup_4532.exe`
- **Multiple instances** of same process
- **Processes with no company name** in version info
- **Suspended processes** (possible hollowing)

### **Step 3: Deep Process Examination**

#### **Using Process Explorer:**
1. **Verify Signatures:** Check digital signatures (green/red)
2. **Check Strings:** Right-click → Properties → Strings tab
3. **DLL Analysis:** View loaded DLLs, look for:
   - Unusual injection (`kernel32.dll` injection common)
   - Missing DLLs (statically linked malware)
4. **Handle Analysis:** See open files, registry keys, mutexes
5. **Thread Analysis:** Check start addresses

#### **Using API Monitor:**
```yaml
Critical APIs to Monitor:
  Process: CreateProcess, CreateRemoteThread, WriteProcessMemory
  File: CreateFile, WriteFile, SetFileAttributes
  Registry: RegSetValue, RegCreateKey
  Network: connect, send, recv, WinHttpConnect
  Crypto: CryptEncrypt, BCryptEncrypt
  Anti-Debug: IsDebuggerPresent, NtQueryInformationProcess
```

### **Step 4: Memory Dump Analysis**

#### **Volatility Framework Commands:**
```bash
# Profile identification
volatility -f memory.dmp imageinfo

# Process listing (multiple methods)
volatility -f memory.dmp --profile=Win10x64 pslist
volatility -f memory.dmp --profile=Win10x64 psscan  # Hidden processes
volatility -f memory.dmp --profile=Win10x64 pstree  # Parent-child

# DLL analysis
volatility -f memory.dmp --profile=Win10x64 dlllist -p [PID]
volatility -f memory.dmp --profile=Win10x64 ldrmodules -p [PID]

# Process memory dump
volatility -f memory.dmp --profile=Win10x64 memdump -p [PID] -D output/

# Network connections
volatility -f memory.dmp --profile=Win10x64 netscan
volatility -f memory.dmp --profile=Win10x64 connections

# API hooks
volatility -f memory.dmp --profile=Win10x64 apihooks -p [PID]

# Extract malicious code
volatility -f memory.dmp --profile=Win10x64 malfind -p [PID]
volatility -f memory.dmp --profile=Win10x64 procdump -p [PID] -D output/
```

### **Step 5: Behavioral Analysis**

#### **Sandbox Execution:**
```yaml
Tools:
  ANY.RUN: Interactive analysis
  Hybrid Analysis: Free automated analysis
  Cuckoo Sandbox: Open-source, customizable
  Joe Sandbox: Commercial, detailed reports

Key Sandbox Outputs:
  - Process tree with malicious nodes highlighted
  - Network traffic with malicious connections
  - File system changes (created/modified/deleted)
  - Registry modifications
  - Screenshots of behavior
  - Detonation score and threat classification
```

---

## **ADVANCED DETECTION TECHNIQUES**

### **1. YARA Memory Scanning**
```c
rule Memory_Malware_Generic {
    meta:
        description = "Detects common malicious patterns in memory"
        author = "Analyst"
    
    strings:
        $mz_header = {4D 5A}  // MZ header in memory
        $shellcode = {FC 48 83 E4 F0 E8}  // Common shellcode prologue
        $xor_loop = {80 30 ?? 40 84 C0 75 F9}  // XOR decryption loop
        $c2_string = /https?:\/\/(?!microsoft|windowsupdate)[a-zA-Z0-9.-]{10,}\//
    
    condition:
        any of them and filesize < 100KB
}
```

### **2. ETW (Event Tracing for Windows) Monitoring**
```powershell
# PowerShell commands for ETW process monitoring
logman create trace "MalwareTrace" -ow -o malware.etl -p "Microsoft-Windows-Kernel-Process" 0x10 0x10 -ets
# ... capture activity ...
logman stop "MalwareTrace" -ets
```

### **3. Kernel Callback Monitoring**
- **PsSetCreateProcessNotifyRoutine:** Monitor process creation
- **PsSetLoadImageNotifyRoutine:** Monitor DLL/image loads
- **CmRegisterCallback:** Monitor registry operations

---

## **SPECIFIC MALWARE FAMILY INDICATORS**

### **Ransomware Processes:**
- **File activity:** Rapid sequential file opens/writes
- **CPU usage:** High during encryption phase
- **Network:** Minimal (some check C2 before encryption)
- **Strings:** Encryption-related API calls, ransom note text

### **Banking Trojans:**
- **Injection:** Targets browser processes (chrome.exe, firefox.exe)
- **Network:** HTTPS to unusual domains
- **Hooks:** Windows hooks (SetWindowsHookEx) for keylogging
- **Persistence:** Registry run keys, scheduled tasks

### **RATs (Remote Access Trojans):**
- **Network:** Persistent connections, often non-standard ports
- **Process:** Often disguised as legitimate services
- **Artifacts:** Screenshot capabilities, file manager functionality
- **Persistence:** Multiple mechanisms (registry, services, WMI)

### **Cryptominers:**
- **CPU/GPU:** Sustained high usage
- **Process names:** Often mimic system processes
- **Network:** Connections to mining pools (stratum protocol)
- **Detection:** Unusual WMI queries for GPU information

---

## **ANTI-ANALYSIS TECHNIQUES & COUNTERMEASURES**

### **Common Anti-Analysis Tricks:**

| **Technique** | **Detection Method** |
|--------------|---------------------|
| **Debugger Detection** | Check for `IsDebuggerPresent`, `NtQueryInformationProcess` |
| **Sandbox Detection** | Check for low RAM, unusual processes, recent installation |
| **VM Detection** | Check for VM-specific registry keys, MAC addresses, devices |
| **Timing Attacks** | Detect accelerated time in sandboxes |
| **User Interaction Checks** | Wait for mouse movement/clicks before executing |

### **Bypassing Anti-Analysis:**
```python
# Analysis environment considerations:
analysis_environment = {
    "memory_analysis": "Use live analysis when possible",
    "debugger_bypass": "Patch detection routines in memory",
    "timing_checks": "Use real hardware, not accelerated VMs",
    "user_simulation": "Tools to simulate mouse/keyboard input",
    "environment_spoofing": "Tools to hide analysis artifacts"
}
```

---

## **TOOLKIT FOR PROCESS ANALYSIS**

### **Windows Native Tools:**
```bash
tasklist /v /fo csv
wmic process get Caption,ProcessId,CommandLine,ParentProcessId
netstat -ano | findstr ESTABLISHED
handle.exe -a [PID]  # Handle/Sysinternals
```

### **Sysinternals Suite Essentials:**
- **Process Explorer:** Advanced task manager
- **Process Monitor:** Real-time file/registry/process monitoring
- **Autoruns:** Startup programs analysis
- **TCPView:** Network connection monitoring
- **VMMap:** Process memory analysis

### **Specialized Tools:**
```
Memory Analysis: Volatility 3, Rekall, WinDbg
Network Analysis: Wireshark, NetworkMiner, Capsa
Malware Sandboxes: ANY.RUN, Hybrid Analysis, VMRay
PE Analysis: PE-bear, DiE, PEStudio
```

### **Scripting & Automation:**
```powershell
# PowerShell process analysis script
Get-Process | Select-Object Name, Id, CPU, 
  @{Name="CommandLine";Expression={$_.CommandLine}},
  @{Name="Parent";Expression={(Get-Process -Id $_.Parent.Id).Name}} |
  Export-Csv -Path "process_analysis.csv"
```

---

## **INCIDENT RESPONSE INTEGRATION**

### **Process Analysis in IR Workflow:**
1. **Identification:** Detect malicious process via alerts
2. **Containment:** Isolate system, but don't kill process immediately
3. **Collection:** Capture memory, process dump, network traffic
4. **Analysis:** Determine scope, capabilities, persistence
5. **Eradication:** Kill process, remove persistence
6. **Recovery:** Restore from backups if needed
7. **Lessons Learned:** Update detection rules

### **Live Response Kits:**
```bash
# Example live response script
#!/bin/bash
echo "=== Incident Response Process Analysis ==="
date >> ir_log.txt
ps aux --sort=-%cpu >> ir_log.txt
lsof -i >> ir_log.txt
netstat -tulpn >> ir_log.txt
ls -la /proc/[PID]/fd/ >> ir_log.txt
cat /proc/[PID]/maps >> ir_log.txt
```

---

## **MEMORY FORENSICS CHALLENGES**

### **Modern Issues:**
1. **Large Memory Dumps:** Systems with 64GB+ RAM
2. **Encrypted Memory:** Some hypervisors/OSes encrypt memory
3. **Non-Volatile RAM:** Persistent memory (PMEM) technologies
4. **Cloud Environments:** Limited access to physical memory
5. **Containerized Processes:** Docker/Kubernetes process isolation

### **Solutions:**
- **Targeted Dumping:** Dump only suspicious processes
- **Live Analysis:** Analyze without dumping
- **API-based Collection:** Use OS APIs for targeted data
- **eBPF Tracing:** Linux kernel tracing for containers

---

## **BEST PRACTICES SUMMARY**

1. **Always capture memory** before killing suspicious processes
2. **Analyze multiple data sources** (process, network, file system)
3. **Look for relationships** between processes, not just individual ones
4. **Baseline normal behavior** for the environment
5. **Document findings** for IOC extraction and future detection
6. **Use both automated and manual analysis** for comprehensive coverage
7. **Keep analysis tools updated** to handle new evasion techniques
8. **Practice regularly** with malware samples in controlled environments

---

## **FUTURE TRENDS**

### **AI-Assisted Analysis:**
- ML models trained on malicious process patterns
- Automated IOC extraction and correlation
- Predictive analysis of process behavior

### **Real-time Memory Protection:**
- Hardware-assisted process isolation (Intel CET, ARM PAC)
- In-memory exploit prevention
- Behavioral blocking based on process actions

### **Cloud-Native Process Analysis:**
- Serverless function monitoring
- Container runtime security
- Kubernetes pod/namespace analysis

### **Quantum-Resistant Process Monitoring:**
- Post-quantum encryption monitoring
- Quantum random number generator analysis

---

**Key Insight:** Malicious process analysis is a **cat-and-mouse game** where attackers continuously evolve evasion techniques and defenders develop new detection methods. The most effective analysts understand **both offensive and defensive perspectives**, allowing them to think like attackers while building robust defenses.

The ultimate goal is not just detecting malicious processes, but **understanding their intent, capabilities, and impact** to mount an effective response and prevent future incidents.
